<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/numbers.css">
    <script src="https://code.createjs.com/easeljs-0.8.0.min.js"></script>
    <script src="https://code.createjs.com/tweenjs-0.6.0.min.js"></script>
    <title>Numbers</title>
</head>
<body onload="init();">
<canvas id="demoCanvas" width="650" height="272">
    alternate content
</canvas>

<button class="bingoButton" onclick="handlePlay();">Play</button>

<script>

    var stage, canvas,
        revealedNumbers = [16, 36, 34, 73, 1, 10, 43, 56, 47, 8, 63, 13, 5, 23, 12, 59, 45, 9, 62, 74, 42, 54, 65, 2, 70, 4, 51, 49, 60, 69, 24, 18, 40, 31, 21, 61, 50, 27, 28, 67, 41, 55, 66, 46, 25];

    function init() {

        createjs.MotionGuidePlugin.install(createjs.Tween);

        canvas = document.getElementById("demoCanvas");
        stage = new createjs.Stage(canvas);

        var image = new Image();
        image.src = "./img/numbers.png";
        image.onload = handleImageLoad;

    }

    function handleImageLoad(event) {
        var image = event.target;
        var bitmap;

        var container = new createjs.Container();
        stage.addChild(container);

        bitmap = new createjs.Bitmap(image);
        container.addChild(bitmap);

        createjs.Ticker.addEventListener("tick", tick);
    }

    function tick(event) {
        stage.update(event);
    }

    function handlePlay() {
        for(var n in revealedNumbers) {
            var ball = createBall(revealedNumbers[n]);
            stage.addChild(ball);
            moveBall(ball, revealedNumbers[n], n)
        }

    }

    function moveBall(ball, number, index) {
        var finalPosition = calculatePositionForBall(number);
        var delay = index * 3300;

        createjs.Tween.get(ball, {loop: false})
                .to({}, delay, createjs.Ease.getPowInOut(1))
                .to({alpha: 1, y: ball.y + 10}, 200, createjs.Ease.getPowInOut(1))
                .to({y: ball.y + 75, x: ball.x - 10, scaleX: 2, scaleY: 2}, 500, createjs.Ease.circIn())
                .to({y: ball.y - 50, x: ball.x - 60, scaleX: 8, scaleY: 8}, 300, createjs.Ease.circIn())
                .wait(1500)
                .to({scaleX: 4, scaleY: 4, x: ball.x + 50, y: ball.y}, 300, createjs.Ease.circIn())
                .wait(300)
                .to({guide:{ path: calculateCurvePoints({x: ball.x + 50, y: ball.y}, calculateControlPoints({x: ball.x  + 50, y: ball.y}, {x: finalPosition.x, y: finalPosition.y}, finalPosition.row).originControlPoint, calculateControlPoints({x: ball.x  + 50, y: ball.y}, {x: finalPosition.x, y: finalPosition.y}, finalPosition.row).targetControlPoint, {x: finalPosition.x, y: finalPosition.y}) }, scaleX: 1.6, scaleY: 1.6}, 400);

        createjs.Ticker.setFPS(60);
        createjs.Ticker.addEventListener("tick", stage);
    }

    function bezier(t, p0, p1, p2, p3){
        var cX = 3 * (p1.x - p0.x),
                bX = 3 * (p2.x - p1.x) - cX,
                aX = p3.x - p0.x - cX - bX;

        var cY = 3 * (p1.y - p0.y),
                bY = 3 * (p2.y - p1.y) - cY,
                aY = p3.y - p0.y - cY - bY;

        var x = (aX * Math.pow(t, 3)) + (bX * Math.pow(t, 2)) + (cX * t) + p0.x;
        var y = (aY * Math.pow(t, 3)) + (bY * Math.pow(t, 2)) + (cY * t) + p0.y;

        return {x: x, y: y};
    }

    function calculatePositionForBall(number) {
        var row, column;
        row = Math.floor(number/10);
        column = (number % 10) - 1;
        if(column == -1) {
            column = 9;
            row--;
        }

        return {
            x: column * 34,
            y: row * 34,
            row: row
        };
    }

    function calculateControlPoints(origin, target, row) {
        var originControlPoint,
            targetControlPoint,
            originControlPointX,
            originControlPointY,
            targetControlPointX,
            targetControlPointY;

        originControlPointX = origin.x - 30;
        targetControlPointX = target.x + 30;
        if(row < 5) {
            originControlPointY = origin.y + 50 * row;
            targetControlPointY = target.y + 20 * (5 - row);
        } else {
            originControlPointY = origin.y - 50 * (row - 4);
            targetControlPointY = target.y - 20 * (row - 4);
        }

        originControlPoint = {
            x: originControlPointX,
            y: originControlPointY
        };

        targetControlPoint = {
            x: targetControlPointX,
            y: targetControlPointY
        };

        return {
            originControlPoint: originControlPoint,
            targetControlPoint: targetControlPoint
        };
    }

    function calculateCurvePoints(p0, p1, p2, p3) {
        var accuracy = 0.15;
        var res = [];
        res.push(p0.x);
        res.push(p0.y);
        for (var i=0; i<1; i+=accuracy){
            var p = bezier(i, p0, p1, p2, p3);
            res.push(p.x);
            res.push(p.y);
        }
        res.push(p3.x);
        res.push(p3.y);
        return res;
    }

    function createBall(number) {
        var radius = 10;
        var ball = new createjs.Container();
        ball.x = 340 + ((canvas.width - 340) / 2) - radius;
        ball.y = 100;
        ball.alpha = 0;
        ball.setBounds(0, 0, radius * 2, radius * 2);


        var circle = new createjs.Shape();
        circle.graphics.beginRadialGradientFill(["white", "lightgrey", "white"], [0, 1, 0], 10, 6, 4, 10, 8, 10).drawCircle(radius, radius, radius);
        circle.shadow = new createjs.Shadow("#555555", 0, 2, 5);
        ball.addChild(circle);

        var text = new createjs.Text();
        text.set({
            text: number,
            font: radius +"px Arial",
            color: "#666666"
        });

        var b = text.getBounds();
        text.x = radius - b.width/2;
        text.y = radius - b.height/2;

        ball.addChild(text);

        return ball;
    }

</script>

</body>
</html>